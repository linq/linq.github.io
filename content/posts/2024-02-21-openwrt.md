---
title: OpenWrt Dockerè½¯è·¯ç”±
description: OpenWrt Dockerè½¯è·¯ç”±
date: 2024-02-21
updated: 2024-02-21
taxonomies:
  tags:
    - è·¯ç”±
    - openwrt
extra:
  emoji: ğŸ’»ï¸
---
åŠå¹´å‰ç”¨ N1 é…åˆ OpenWrt æ­å»ºäº†è½¯è·¯ç”±ï¼Œä¹Ÿç¨³å®šè¿è¡Œäº†åŠå¹´ã€‚è¿™å‘¨å¿ƒè¡€æ¥æ½®æƒ³æŠ˜è…¾å…¶ä»–çš„ä¸Šç½‘æ–¹å¼ï¼ŒæŠŠ OpenWrt è½¯è·¯ç”±å‡çº§äº†ä¸‹ï¼Œä¸­é—´çš„æ­¥éª¤ä¹Ÿä¸å°‘ï¼Œæ­£å¥½è®°å½•ä¸‹ã€‚

## Docker å‡†å¤‡

é¦–å…ˆæ˜¯ docker ç¯å¢ƒå‡†å¤‡ï¼Œè¿™ä¸ªç°åœ¨ä¸€èˆ¬ NAS å•¥çš„éƒ½è‡ªå¸¦ï¼Œæˆ‘ç”¨çš„ [Armbian](https://github.com/ophub/amlogic-s9xxx-armbian/tree/main) ä¹Ÿæ˜¯ï¼Œé™¤äº†ä¿®æ”¹ä¸‹é•œåƒåŠ é€Ÿä¹Ÿæ²¡å•¥æ”¹åŠ¨ã€‚

`daemon.json` å¢åŠ  registry-mirrors
```bash
  "registry-mirrors": [
    "https://dockerproxy.com"
  ]
```

## ç½‘ç»œå‡†å¤‡

æ‰“å¼€ç½‘å¡æ··æ‚æ¨¡å¼
```bash
sudo ip link set eth0 promisc on
```

åˆ›å»º macvlan è™šæ‹Ÿç½‘å¡
```bash
docker network create -d macvlan --subnet=192.168.xxx.0/24 --gateway=192.168.xxx.yyy -o parent=eth0 macnet
```

## OpenWrt é•œåƒå‡†å¤‡

è¿™é‡Œæ¨èä¸¤ä¸ªï¼š
- [ophub/openwrt-aarch64](https://hub.docker.com/r/ophub/openwrt-aarch64)
- [piaoyizy/openwrt-aarch64](https://hub.docker.com/r/piaoyizy/openwrt-aarch64)

å¦‚æœè¦æ¸…çˆ½å¹²å‡€å¯æ˜¯ä½¿ç”¨ç¬¬ä¸€ä¸ªï¼Œå¦‚æœæœ‰é­”æ³•ä¸Šç½‘éœ€æ±‚é€‰æ‹©ç¬¬äºŒä¸ªï¼Œä½¿ç”¨ä¸Šéƒ½æ²¡æœ‰åŒºåˆ«

## å¯åŠ¨ OpenWrt å¹¶é…ç½®ç½‘ç»œ

é¦–å…ˆå¯åŠ¨å®¹å™¨
```bash
docker run -d --name=openwrt --network macnet --privileged --restart always ophub/openwrt-aarch64:latest
```

è¿›å…¥ OpenWrt
```bash
docker exec -it openwrt bash
```

ä¿®æ”¹ IPã€ç½‘å…³ã€DNS ç­‰
```bash
vi /etc/config/network
```

ä¿®æ”¹å®Œé‡å¯ OpenWrt ç½‘ç»œ
```bash
/etc/init.d/network restart
```

## è½¯è·¯ç”±è®¾ç½®

ä¸Šé¢æ‰§è¡Œå®Œæˆåå°±å¯ä»¥é€šè¿‡ ip ç™»é™†è½¯è·¯ç”±ï¼Œè¾“å…¥å¯†ç åè¿›è¡Œç›¸å…³çš„è®¾ç½®ã€‚

### LAN æ¥å£è®¾ç½®

è¿›å…¥ `ç½‘ç»œ - æ¥å£ - LAN`ï¼Œæ‰§è¡Œä»¥ä¸‹ä¿®æ”¹
1. å…³é—­ DHCP
2. `IPv4 ç½‘å…³`å’Œ `DNS æœåŠ¡å™¨`éƒ½å¡«å†™ä¸»è·¯ç”±åœ°å€
3. åœ¨`ç‰©ç†è®¾ç½®`ä¸­ï¼Œå–æ¶ˆ`æ¡¥æ¥æ¥å£`é€‰é¡¹

### é˜²ç«å¢™è®¾ç½®

è¿›å…¥ `ç½‘ç»œ - é˜²ç«å¢™ - è‡ªå®šä¹‰è§„åˆ™`ï¼Œæ·»åŠ 
```bash
iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE
```
ä¿®æ”¹åé‡å¯é˜²ç«å¢™

## Armbian è®¾ç½® (å¯é€‰)

å¯¹äºä½¿ç”¨ Armbianï¼Œå®ç°å’Œ OpenWrt äº’ç›¸è®¿é—®
ä¿®æ”¹ `/etc/network/interfaces`ï¼Œå¢åŠ 
```bash
auto macvlan
iface macvlan inet dhcp
        pre-up ip link add macvlan link eth0 type macvlan mode bridge
        post-down ip link del macvlan link eth0 type macvlan mode bridge
```

## OpenClash è®¾ç½®

å¯¹äºéœ€è¦ OpenClash é­”æ³•ä¸Šç½‘çš„ï¼Œé¦–æ¬¡æ·»åŠ è®¢é˜…å¤§æ¦‚ç‡æ— æ³•å¯åŠ¨ã€‚æŸ¥çœ‹æ—¥å¿—ä¼šå‘ç°æ˜¯å› ä¸º clash å†…æ ¸æ— æ³•ä¸‹è½½ï¼Œæ‰€ä»¥éœ€è¦å…ˆä¸‹è½½å†…æ ¸ã€‚

è¿›å…¥ `OpenClash - æ’ä»¶è®¾ç½® - ç‰ˆæœ¬æ›´æ–°`ï¼Œåœ¨ Dev å†…æ ¸ä¸­ç‚¹å‡»ä¸‹è½½ï¼Œå¯ä»¥æŠŠå†…æ ¸å…ˆä¸‹è½½åˆ°æœ¬åœ°ã€‚

ssh ç™»é™† OpenClash å¹¶ä¸Šä¼  clash å†…æ ¸åˆ° `/etc/openclash/core`ï¼Œå¯èƒ½ä¼šæ²¡æœ‰æ–‡ä»¶å¤¹è®°å¾—åˆ›å»ºï¼Œç„¶åä¿®æ”¹æ–‡ä»¶æƒé™
```bash
chmod 0700 clash  
chown nobody:nogroup clash
```

ä¿®æ”¹åé‡å¯ OpenClash åº”è¯¥å°±å¯ä»¥äº†
