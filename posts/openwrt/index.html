<!doctype html><html lang=zh><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><meta content="index, follow" name=robots><title>OpenWrt Docker软路由</title><meta content="OpenWrt Docker软路由" name=title><meta content=Dirigo name=author><meta content="OpenWrt Docker软路由" name=description><meta content=website property=og:type><meta content=https://linq.github.io/posts/openwrt/ property=og:url><meta property=og:site_name><meta content="OpenWrt Docker软路由" property=og:title><meta content="OpenWrt Docker软路由" property=og:description><meta content=https://linq.github.io/favicon.ico property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://linq.github.io/posts/openwrt/ property=twitter:url><meta content="OpenWrt Docker软路由" property=twitter:title><meta content="OpenWrt Docker软路由" property=twitter:description><meta content=https://linq.github.io/favicon.ico property=twitter:image><link href=https://linq.github.io/posts/openwrt/ rel=canonical><link rel="shortcut icon" href=https://linq.github.io/favicon.ico type=image/x-icon><link href=https://linq.github.io/atom.xml rel=alternate title=RSS type=application/atom+xml><link href=https://linq.github.io/css/style.css rel=stylesheet><link href=https://linq.github.io/css/custom.css rel=stylesheet><script defer src=https://linq.github.io/js/script.js></script><body><div class=wrapper><header><nav class=navBar><a href=/> /首页/ </a><a href=/archive> /归档/ </a><a href=/tags> /标签/ </a><a href=/book> /图书/ </a><div class=themeSwitch><button class="themeButton light" onclick="setTheme('light')" title="Light mode"><svg class="icons icons__background"><use href=https://linq.github.io/icons.svg#lightMode></use></svg></button><button class="themeButton dark" onclick="setTheme('dark')" title="Dark mode"><svg class="icons icons__background"><use href=https://linq.github.io/icons.svg#darkMode></use></svg></button></div></nav></header><main><h1>OpenWrt Docker软路由</h1><p>半年前用 N1 配合 OpenWrt 搭建了软路由，也稳定运行了半年。这周心血来潮想折腾其他的上网方式，把 OpenWrt 软路由升级了下，中间的步骤也不少，正好记录下。<h2 id=docker-zhun-bei>Docker 准备</h2><p>首先是 docker 环境准备，这个现在一般 NAS 啥的都自带，我用的 <a href=https://github.com/ophub/amlogic-s9xxx-armbian/tree/main rel=noopener target=_blank>Armbian</a> 也是，除了修改下镜像加速也没啥改动。<p><code>daemon.json</code> 增加 registry-mirrors<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span>  "</span><span style=color:#a3be8c>registry-mirrors</span><span>"</span><span style=color:#bf616a>:</span><span> [
</span><span>    "</span><span style=color:#a3be8c>https://dockerproxy.com</span><span>"
</span><span>  </span><span style=color:#bf616a>]
</span></code></pre><h2 id=wang-luo-zhun-bei>网络准备</h2><p>打开网卡混杂模式<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>sudo</span><span> ip link set eth0 promisc on
</span></code></pre><p>创建 macvlan 虚拟网卡<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>docker</span><span> network create</span><span style=color:#bf616a> -d</span><span> macvlan</span><span style=color:#bf616a> --subnet</span><span>=192.168.xxx.0/24</span><span style=color:#bf616a> --gateway</span><span>=192.168.xxx.yyy</span><span style=color:#bf616a> -o</span><span> parent=eth0 macnet
</span></code></pre><h2 id=openwrt-jing-xiang-zhun-bei>OpenWrt 镜像准备</h2><p>这里推荐两个：<ul><li><a href=https://hub.docker.com/r/ophub/openwrt-aarch64 rel=noopener target=_blank>ophub/openwrt-aarch64</a><li><a href=https://hub.docker.com/r/piaoyizy/openwrt-aarch64 rel=noopener target=_blank>piaoyizy/openwrt-aarch64</a></ul><p>如果要清爽干净可是使用第一个，如果有魔法上网需求选择第二个，使用上都没有区别<h2 id=qi-dong-openwrt-bing-pei-zhi-wang-luo>启动 OpenWrt 并配置网络</h2><p>首先启动容器<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>docker</span><span> run</span><span style=color:#bf616a> -d --name</span><span>=openwrt</span><span style=color:#bf616a> --network</span><span> macnet</span><span style=color:#bf616a> --privileged --restart</span><span> always ophub/openwrt-aarch64:latest
</span></code></pre><p>进入 OpenWrt<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>docker</span><span> exec</span><span style=color:#bf616a> -it</span><span> openwrt bash
</span></code></pre><p>修改 IP、网关、DNS 等<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>vi</span><span> /etc/config/network
</span></code></pre><p>修改完重启 OpenWrt 网络<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>/etc/init.d/network</span><span> restart
</span></code></pre><h2 id=ruan-lu-you-she-zhi>软路由设置</h2><p>上面执行完成后就可以通过 ip 登陆软路由，输入密码后进行相关的设置。<h3 id=lan-jie-kou-she-zhi>LAN 接口设置</h3><p>进入 <code>网络 - 接口 - LAN</code>，执行以下修改<ol><li>关闭 DHCP<li><code>IPv4 网关</code>和 <code>DNS 服务器</code>都填写主路由地址<li>在<code>物理设置</code>中，取消<code>桥接接口</code>选项</ol><h3 id=fang-huo-qiang-she-zhi>防火墙设置</h3><p>进入 <code>网络 - 防火墙 - 自定义规则</code>，添加<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>iptables -t</span><span> nat</span><span style=color:#bf616a> -I</span><span> POSTROUTING</span><span style=color:#bf616a> -o</span><span> eth0</span><span style=color:#bf616a> -j</span><span> MASQUERADE
</span></code></pre><p>修改后重启防火墙<h2 id=armbian-she-zhi-ke-xuan>Armbian 设置 (可选)</h2><p>对于使用 Armbian，实现和 OpenWrt 互相访问 修改 <code>/etc/network/interfaces</code>，增加<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>auto</span><span> macvlan
</span><span style=color:#bf616a>iface</span><span> macvlan inet dhcp
</span><span>        </span><span style=color:#bf616a>pre-up</span><span> ip link add macvlan link eth0 type macvlan mode bridge
</span><span>        </span><span style=color:#bf616a>post-down</span><span> ip link del macvlan link eth0 type macvlan mode bridge
</span></code></pre><h2 id=openclash-she-zhi>OpenClash 设置</h2><p>对于需要 OpenClash 魔法上网的，首次添加订阅大概率无法启动。查看日志会发现是因为 clash 内核无法下载，所以需要先下载内核。<p>进入 <code>OpenClash - 插件设置 - 版本更新</code>，在 Dev 内核中点击下载，可以把内核先下载到本地。<p>ssh 登陆 OpenClash 并上传 clash 内核到 <code>/etc/openclash/core</code>，可能会没有文件夹记得创建，然后修改文件权限<pre class=language-bash data-lang=bash style=background:#2b303b;color:#c0c5ce><code class=language-bash data-lang=bash><span style=color:#bf616a>chmod</span><span> 0700 clash  
</span><span style=color:#bf616a>chown</span><span> nobody:nogroup clash
</span></code></pre><p>修改后重启 OpenClash 应该就可以了<p class=tagsData><a href=/tags/lu-you>/路由/</a> <a href=/tags/openwrt>/openwrt/</a></main><footer><hr><div class=footContainer><div class=footLeft><p>Licensed under <a rel="noopener noreferrer" href=https://fr.wikipedia.org/wiki/Licence_MIT target=_blank>MIT</a><br> Built with <a rel="noopener noreferrer" href=https://www.getzola.org target=_blank>Zola</a> using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> theme & <a rel="noopener noreferrer" href=https://github.com/Speyll/veqev target=_blank>veqev</a> colors.<br></div><div class=footRight><a rel="noopener noreferrer" title="Subscribe via RSS for updates." class=icons__background href=https://linq.github.io/atom.xml target=_blank><svg class="icons icons__background"><use href=https://linq.github.io/icons.svg#rss></use></svg></a></div></div></footer></div>